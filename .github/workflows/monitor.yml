name: Workflow Monitoring

on:
  workflow_run:
    workflows: ["Ideation Claude Evaluation", "Tests"]
    types:
      - completed
      - in_progress
  schedule:
    # Check every 5 minutes during business hours
    - cron: '*/5 9-17 * * 1-5'

jobs:
  monitor:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get workflow status
        id: status
        run: |
          gh run list --limit 5 --json status,conclusion,displayTitle,createdAt --jq '.[] | "\(.displayTitle) - \(.status) - \(.conclusion // "running") - \(.createdAt)"' > workflow_status.txt
          cat workflow_status.txt

      - name: Check for failures
        id: failures
        run: |
          FAILED=$(gh run list --limit 10 --json conclusion --jq '[.[] | select(.conclusion == "failure")] | length')
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          if [ "$FAILED" -gt 0 ]; then
            echo "âš  Found $FAILED failed workflow runs"
          fi

      - name: Generate status report
        run: |
          echo "# Workflow Status Report" > status_report.md
          echo "Generated: $(date)" >> status_report.md
          echo "" >> status_report.md
          echo "## Recent Runs" >> status_report.md
          gh run list --limit 10 --json status,conclusion,displayTitle,createdAt,url --jq '.[] | "- [\(.displayTitle)](\(.url)): \(.status) - \(.conclusion // "running")"' >> status_report.md
          cat status_report.md

      - name: Upload status report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-status-report
          path: status_report.md
          if-no-files-found: ignore

